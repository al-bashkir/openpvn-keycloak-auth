# Example OpenVPN server systemd unit with Keycloak SSO support.
#
# Based on the production template.  This replaces the stock
# openvpn-server@.service unit so that:
#   1. OpenVPN starts AFTER the SSO daemon and hard-depends on it.
#   2. LimitNPROC is raised to 512 so the Go auth script can spawn
#      enough OS threads for the runtime (GC, scheduler, netpoller).
#
# Install:
#   sudo cp deploy/openvpn-server@.service.example \
#        /etc/systemd/system/openvpn_<instance>.service
#   sudo systemctl daemon-reload
#
# Alternatively, use the drop-in override for the stock unit:
#   sudo mkdir -p /etc/systemd/system/openvpn-server@.service.d
#   sudo cp deploy/openvpn-sso-override.conf \
#        /etc/systemd/system/openvpn-server@.service.d/sso-override.conf
#   sudo systemctl daemon-reload

[Unit]
Description=OpenVPN service for %i
After=syslog.target network-online.target openvpn-keycloak-sso.service
Wants=network-online.target openvpn-keycloak-sso.service
Requires=openvpn-keycloak-sso.service
Documentation=man:openvpn(8)
Documentation=https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage
Documentation=https://community.openvpn.net/openvpn/wiki/HOWTO

[Service]
Type=notify
PrivateTmp=true
WorkingDirectory=/etc/openvpn/server/%i
ExecStart=/usr/sbin/openvpn --status %t/openvpn-server/status-%i.log --status-version 2 --config server.conf
CapabilityBoundingSet=CAP_IPC_LOCK CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW CAP_SETGID CAP_SETUID CAP_SYS_CHROOT CAP_DAC_OVERRIDE

# OpenVPN runs auth scripts with the service RLIMIT_NPROC.
# openvpn-keycloak-sso is a Go binary and needs multiple OS threads.
LimitNPROC=512

DeviceAllow=/dev/null rw
DeviceAllow=/dev/net/tun rw
ProtectSystem=true
ProtectHome=true

# Allow OpenVPN to read/write auth control files in the shared tmp directory.
# This is the same directory referenced by tmp-dir in server.conf.
ReadWritePaths=/var/lib/openvpn-keycloak-sso

KillMode=process
RestartSec=7s
Restart=on-failure

[Install]
WantedBy=multi-user.target
