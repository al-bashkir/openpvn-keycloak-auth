# Systemd drop-in override for the OpenVPN server unit.
#
# The Go-based SSO auth script needs more OS threads than the default
# OpenVPN unit allows.  Without this override the Go runtime crashes
# with "newosproc" / errno=11 (EAGAIN) because RLIMIT_NPROC is too low.
#
# Install:
#   sudo mkdir -p /etc/systemd/system/openvpn-server@.service.d
#   sudo cp deploy/openvpn-sso-override.conf \
#        /etc/systemd/system/openvpn-server@.service.d/sso-override.conf
#   sudo systemctl daemon-reload
#   sudo systemctl restart openvpn-server@server
#
# If you use openvpn@.service instead of openvpn-server@.service,
# adjust the path accordingly.

[Unit]
# Hard dependency: OpenVPN must not start without the SSO daemon.
After=openvpn-keycloak-sso.service
Wants=openvpn-keycloak-sso.service
Requires=openvpn-keycloak-sso.service

[Service]
# Allow child processes (auth scripts) to create enough OS threads
# for the Go runtime (GC, scheduler, netpoller, etc.).
LimitNPROC=512

# Allow OpenVPN to read/write auth control files in the shared tmp directory.
# This is the same directory referenced by tmp-dir in server.conf.
ReadWritePaths=/var/lib/openvpn-keycloak-sso
